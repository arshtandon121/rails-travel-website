<html lang="en">
  <head>
    <meta charset="UTF-8">
    <%= csrf_meta_tags %>
    <%= csp_meta_tag %>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= @camp.name %> Details</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/slick-carousel@1.8.1/slick/slick.css"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/slick-carousel@1.8.1/slick/slick-theme.css"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11.0.19/dist/sweetalert2.min.css">
     <script src="https://cdnjs.cloudflare.com/ajax/libs/tiny-slider/2.9.3/min/tiny-slider.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tiny-slider/2.9.3/tiny-slider.css">
    <style>
      .loader {
       position: fixed;
       top: 0;
       left: 0;
       width: 100%;
       height: 100%;
       background-color: rgba(0, 0, 0, 0.7);
       display: flex;
       justify-content: center;
       align-items: center;
       z-index: 9999;
       }

       .loader-content {
       background-color: #fff;
       padding: 20px;
       border-radius: 10px;
       text-align: center;
       box-shadow: 0 0 20px rgba(0, 0, 0, 0.2);
       }

       .loader-spinner {
       width: 50px;
       height: 50px;
       border: 5px solid #f3f3f3;
       border-top: 5px solid #3498db;
       border-radius: 50%;
       animation: spin 1s linear infinite;
       margin: 0 auto 15px;
       }

       .loader-text {
       color: #333;
       font-size: 18px;
       margin-bottom: 15px;
       }

       .loader-bar {
       width: 200px;
       height: 10px;
       background-color: #f3f3f3;
       border-radius: 5px;
       overflow: hidden;
       }

       .loader-bar-fill {
       width: 0;
       height: 100%;
       background-color: #3498db;
       animation: fill 2s linear infinite;
       }

       @keyframes spin {
       0% { transform: rotate(0deg); }
       100% { transform: rotate(360deg); }
       }

       @keyframes fill {
       0% { width: 0; }
       50% { width: 100%; }
       100% { width: 0; }
       }


       .coupon-item.active {
           border: 2px solid #4CAF50;
           background-color: rgba(76, 175, 80, 0.1);
       }


       .swal2-popup {
           color: #dc3545;
           background-color: #1e1e1e;
           font-size: 0.8rem;
       }

       body {
           background-color: #121212;
           color: #e0e0e0;
           font-family: 'Roboto', sans-serif;
       }
           .camp-image {
               width: 100%;
               height: 400px;
               object-fit: cover;
               border-radius: 15px;
               box-shadow: 0 4px 8px rgba(0,0,0,0.1);
           }
           .camp-details, .purchase-box {
               background-color: #1e1e1e;
               padding: 30px;
               border-radius: 15px;
               box-shadow: 0 4px 20px rgba(0,0,0,0.08);
               transition: all 0.3s ease;
           }
           .camp-details:hover, .purchase-box:hover {
               transform: translateY(-5px);
               box-shadow: 0 6px 25px rgba(0,0,0,0.1);
           }
           .btn-purchase {
               background-color: #4CAF50;
               color: #121212;
               border: 2px solid #4CAF50;

               font-weight: bold;
               padding: 12px 24px;
               border-radius: 30px;
               transition: all 0.3s ease;
           }
           .btn-purchase:hover {
               background-color: #45a049;
               transform: scale(1.05);
           }
           .camp-rating {
               font-size: 24px;
               color: #FFA500;
           }
           .feature-item {
               display: inline-block;
               margin: 5px;
               padding: 8px 15px;
               background-color: #2a2a2a;
               color: #e0e0e0;
               border-radius: 20px;
               font-size: 0.9em;
               transition: all 0.3s ease;
           }
           .feature-item:hover {
               background-color: #4CAF50;
               color: #121212;
           }
           .quantity-input {
               width: 120px;
           }
           .quantity-input button {
               border: none;
               background-color: #f8f9fa;
               color: #4CAF50;
               font-weight: bold;
               transition: all 0.3s ease;
           }
           .quantity-input button:hover {
               background-color: #4CAF50;
               color: #121212;
           }
           .datepicker {
               border: 2px solid #4CAF50;
               border-radius: 10px;
               padding: 10px;
           }
           .error-message {
               color: #dc3545;
               background-color: #1e1e1e;
               font-size: 0.9em;
               margin-top: 5px;
           }


           .text-primary {
               color: #FFA500 !important;
           }

           .text-muted {
               color: #a0a0a0 !important;
           }

           /* Sweet Alert customization */
           .small-notification {
               font-size: 0.8rem !important;
           }
           .swal2-popup {
               background-color: #1e1e1e !important;
           }
           .swal2-title, .swal2-content {
               color: #e0e0e0 !important;
           }
           .swal2-close {
               color: #e0e0e0 !important;
           }
           .swal2-timer-progress-bar {
               background-color: rgba(255, 165, 0, 0.5) !important; /* Semi-transparent orange */
           }

           .fullscreen-loader {
               position: fixed;
               top: 0;
               left: 0;
               width: 100%;
               height: 100%;
               background-color: rgba(0, 0, 0, 0.7);
               display: flex;
               justify-content: center;
               align-items: center;
               z-index: 9999;
           }

           .coupon-modal {
               position: fixed;
               top: 50%;
               left: 50%;
               transform: translate(-50%, -50%);
               background-color: #1e1e1e;
               padding: 20px;
               border-radius: 10px;
               z-index: 10000;
               max-width: 80%;
               max-height: 80%;
               overflow-y: auto;
           }

           .coupon-item {
               background-color: #2a2a2a;
               margin-bottom: 10px;
               padding: 10px;
               border-radius: 5px;
           }

           .coupon-code {
               font-weight: bold;
               color: #4CAF50;
           }

           #manual-coupon-input {
               margin-top: 10px;
           }


           .coupon-section {
               background-color: #2a2a2a;
               border-radius: 10px;
               padding: 20px;
               margin-top: 20px;
               box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
           }

           .coupon-section h4 {
               color: #FFA500;
               margin-bottom: 15px;
           }

           .coupon-btn {
               background-color: #4CAF50;
               color: white;
               border: none;
               padding: 10px 15px;
               border-radius: 5px;
               cursor: pointer;
               transition: background-color 0.3s ease;
           }

           .coupon-btn:hover {
               background-color: #45a049;
           }

           .coupon-input {
               background-color: #1e1e1e;
               border: 1px solid #4CAF50;
               color: #e0e0e0;
               padding: 10px;
               border-radius: 5px;
               width: 100%;
               margin-bottom: 10px;
           }

           .coupon-info {
               background-color: #1e1e1e;
               border-radius: 5px;
               padding: 10px;
               margin-top: 15px;
           }

           .coupon-info p {
               margin: 5px 0;
               color: #a0a0a0;
           }

           .coupon-info span {
               color: #4CAF50;
               font-weight: bold;
           }

           .celebration-overlay {
               position: fixed;
               top: 0;
               left: 0;
               width: 100%;
               height: 100%;
               background-color: rgba(0, 0, 0, 0.7);
               display: flex;
               justify-content: center;
               align-items: center;
               z-index: 9999;
               opacity: 0;
               pointer-events: none;
               transition: opacity 0.3s ease;
           }

           .celebration-content {
               text-align: center;
               color: #fff;
               font-size: 2rem;
               animation: bounce 0.5s ease infinite alternate;
           }

           @keyframes bounce {
               from { transform: translateY(0px); }
               to { transform: translateY(-10px); }
           }

           .confetti {
               position: absolute;
               width: 10px;
               height: 10px;
               background-color: #f0f0f0;
               opacity: 0;
           }

           @keyframes confetti-fall {
               0% { transform: translateY(0) rotate(0deg); opacity: 1; }
               100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
           }

       #remove-discount-btn {
           background-color: #dc3545;
           color: #fff;
           border: none;
           padding: 5px 10px;
           border-radius: 5px;
           cursor: pointer;
           margin-top: 10px;
       }

       #remove-discount-btn:hover {
           background-color: #c82333;
       }

       .coupon-item {
           background-color: #2a2a2a;
           border: 1px solid #3a3a3a;
           border-radius: 5px;
           padding: 10px;
           margin-bottom: 10px;
           transition: all 0.3s ease;
       }

       .coupon-item:hover {
           background-color: #333;
       }

       .coupon-item.eligible {
           border-color: #4CAF50;
       }

       .coupon-item.not-eligible {
           opacity: 0.7;
       }

       .coupon-item input[type="radio"] {
           display: none;
       }

       .coupon-item label {
           display: block;
           cursor: pointer;
       }

       .coupon-code {
           font-weight: bold;
           color: #FFA500;
           margin-bottom: 5px;
       }

       .coupon-details {
           font-size: 0.9em;
           color: #a0a0a0;
       }

       .eligibility {
           display: block;
           margin-top: 5px;
           font-size: 0.9em;
       }

       .eligibility.eligible {
           color: #4CAF50;
       }

       .eligibility.not-eligible {
           color: #FFA500;
       }

       .fa-check-circle {
           margin-right: 5px;
       }


      .copy-btn {
       background: none;
       border: none;
       margin-left: 8px;
       cursor: pointer;
       color: white;
       transition: color 0.3s ease, transform 0.3s ease;
      }

      .copy-btn:hover {
       color: #0056b3;
       transform: scale(1.1);
      }

      .copy-btn:focus {
       outline: none;
      }

      .copy-btn i {
       font-size: 1em;
      }



      .purchase-box {
        position: sticky;
        top: 50px; /* Adjust as needed */
        z-index: 1000; /* Ensure it stays on top of other content */
      }


      .lg-fixed {

      }

      @media (min-width: 768px) { /* For medium (md) devices and up */
       .lg-fixed {
           position: fixed; /* Fixed for md and lg devices */


       }
      }

      .camp-image-slider-container {
            margin: 0 auto;
            height: 50%;
            overflow: hidden;
            position: relative;
            margin-bottom:  20px;
        }
        .camp-image-slider {
            height: 100%;
        }
        .camp-image {
            width: 100%;
            height: fit-content;
            object-fit: cover;
            object-position: center;
        }
        .tns-nav {
            text-align: center;
            margin-top: 10px;
        }
        .tns-nav button {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #ccc;
            border: none;
            margin: 0 5px;
        }
        .tns-nav .tns-nav-active {
            background: #000;
        }
        .slider-arrow {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(0, 0, 0, 0.5);
            color: #fff;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background 0.3s ease;
            z-index: 10;
        }
        .slider-arrow:hover {
            background: rgba(0, 0, 0, 0.8);
        }
        .slider-arrow-prev {
            left: 10px;
        }
        .slider-arrow-next {
            right: 10px;
        }

    </style>
  </head>
  <body>
    <div id="loader" class="loader" style="display: none;">
      <div class="loader-content">
        <div class="loader-spinner"></div>
        <div class="loader-text">Loading...</div>
        <div class="loader-bar">
          <div class="loader-bar-fill"></div>
        </div>
      </div>
    </div>
    <div class="container mt-5">
      <div class="row">
        <!-- Left Column: Camp Details -->
        <div class="col-md-8">
          <!-- Camp Image Slider -->
          <div class="camp-image-slider-container">
              <div class="camp-image-slider">
                  <% @pics = @camp.camp_pictures.present? ? @camp.camp_pictures.map { |picture| { url: url_for(picture.image) } } : [] %>
                  <% @pics.each_with_index do |image, index| %>
                      <img src="<%= image[:url] %>" alt="<%= @camp.name %>" class="camp-image">
                  <% end %>
              </div>
              <button class="slider-arrow slider-arrow-prev">&#10094;</button>
              <button class="slider-arrow slider-arrow-next">&#10095;</button>
          </div>
          <!-- Camp Details -->
          <div class="camp-details purchase-box">
            <h1 class="mb-4"><%= @camp.name %></h1>
            <!-- Camp Info -->
            <div class="camp-info mb-4">
              <span class="camp-duration"><i class="fas fa-clock"></i> <%= @camp.camp_duration %></span>
              <span class="camp-rating">
                <%= "â˜…" * @camp.rating.to_i %><%= "â˜†" * (5 - @camp.rating.to_i) %> <%= @camp.rating %>
              </span>
            </div>
            <!-- Location -->
            <p><i class="fas fa-map-marker-alt"></i> <%= @camp.location %></p>
            <!-- Dates -->
            <div class="dates mt-4">
              <div class="row">
                <div class="col-md-12 mb-3 d-flex justify-content-between">
                  <label for="date-range">Select Dates</label>
                  <input type="text" id="date-range" class="form-control w-75" placeholder="Select check-in and check-out dates">
                </div>
              </div>
              <div id="date-error" class="error-message" style="display: none;"></div>
            </div>
            <!-- Sharing Options -->
            <% if @camp.sharing_fields %>
              <div id="sharing-options" class="d-none mt-4">
                <h3 class="mt-4 mb-3">Sharing Options</h3>
                <% ["Double", "Triple", "Quad", "Six"].each do |sharing| %>
                  <div class="sharing-option mb-3 d-none" id="<%= sharing.downcase %>-sharing-info">
                    <div class="d-flex justify-content-between align-items-center">
                      <span>
                        <%= sharing %> Sharing
                        <span id="<%= sharing.downcase %>-price" class="text-success"></span>
                        <span class="per-person-price text-muted" id="<%= sharing.downcase %>-per-person" style="display:none; color: #FFA500 !important;"></span>
                      </span>
                      <div class="quantity-input">
                        <button class="btn btn-outline-secondary btn-sm" onclick="changeQuantity('<%= sharing.downcase %>', -1)">-</button>
                        <input type="number" id="<%= sharing.downcase %>-sharing" name="<%= sharing.downcase %>_sharing" value="0" min="0" class="form-control form-control-sm d-inline-block w-50 text-center">
                        <button class="btn btn-outline-secondary btn-sm" onclick="changeQuantity('<%= sharing.downcase %>', 1)">+</button>
                      </div>
                    </div>
                  </div>
                <% end %>
              </div>
            <% end %>
            <!-- Price Info -->
            <div id="total-price" class="mt-3 font-weight-bold"></div>
            <input type="hidden" id="camp-id" value="<%= @camp.id %>">
            <input type="hidden" id="check-in" value="<%= @check_in %>">
            <input type="hidden" id="check-out" value="<%= @check_out %>">
            <!-- Camp Features -->
            <div class="camp-features mt-4">
              <h3>Included Features</h3>
              <% @camp.feature&.each do |feature| %>
                <span class="feature-item"><i class="fas fa-check-circle"></i> <%= feature %></span>
              <% end %>
            </div>
            <!-- Rafting Options -->
            <% if @camp.per_km_field %>
              <div id="rafting-options" class="d-none mt-4">
                <h3>Select Distance</h3>
                <div class="btn-group" role="group" aria-label="Distance options">
                  <input type="radio" class="btn-check" name="distance" id="distance-11" value="11" checked>
                  <label class="btn btn-outline-primary" for="distance-11">11 km</label>
                  <input type="radio" class="btn-check" name="distance" id="distance-16" value="16">
                  <label class="btn btn-outline-primary" for="distance-16">16 km</label>
                  <input type="radio" class="btn-check" name="distance" id="distance-24" value="24">
                  <label class="btn btn-outline-primary" for="distance-24">24 km</label>
                </div>
              </div>
            <% end %>
            <!-- Person Count Options -->
            <% if @camp.per_person_field %>
              <div id="person-count" class="d-none mt-4">
                <h3>Number of Persons</h3>
                <div class="input-group">
                  <button type="button" class="btn btn-outline-secondary" id="decrease-persons">-</button>
                  <input type="number" name="number_of_persons" id="number_of_persons" value="1" min="1" class="form-control text-center">
                  <button type="button" class="btn btn-outline-secondary" id="increase-persons">+</button>
                </div>
              </div>
            <% end %>
          </div>
        </div>

          <div class="celebration-overlay" id="celebrationOverlay">
                    <div class="celebration-content">
                        <h2>Woohoo! Discount Applied!</h2>
                        <p>You just saved some money! ðŸŽ‰ðŸ’°</p>
                    </div>

          </div>
          
        <!-- Right Column: Booking Form -->
        <div class="col-md-4">
          <div class="lg-fixed">
            <h2 class="mb-3">Book Your Adventure</h2>
            <h3 id="display-price" class="text-primary mb-4">â‚¹<%= 0 %></h3>
            <button id="book-now-btn" class="btn btn-lg btn-purchase w-100 mb-3">Book Now</button>
            <%= form_tag bookings_path, method: :post, id: 'payment-form', style: 'display: none;' do %>
              <%= hidden_field_tag :camp_id, @camp.id %>
              <%= hidden_field_tag :master_total_price, 0 %>              
              <%= hidden_field_tag :razorpay_payment_id %>
              <%= hidden_field_tag :double_sharing %>
              <%= hidden_field_tag :triple_sharing %>
              <%= hidden_field_tag :quad_sharing %>
              <%= hidden_field_tag :six_sharing %>
              <%= hidden_field_tag :total_price %>
              <%= hidden_field_tag :check_in_date %>
              <%= hidden_field_tag :check_out_date %>
              <%= hidden_field_tag :applied_coupon_id %>
              <%= hidden_field_tag :hidden_number_of_persons, value: 1 %>
              <%= hidden_field_tag :selected_distance %>
              <div class="form-group mb-3">
                <%= label_tag :name, "Name" %>
                <%= text_field_tag :name, nil, class: 'form-control', required: true %>
              </div>
              <div class="form-group mb-3">
                <%= label_tag :email, "Email" %>
                <%= email_field_tag :email, nil, class: 'form-control', required: true %>
              </div>
              <div class="form-group mb-3">
                <%= label_tag :phone, "Phone" %>
                <%= telephone_field_tag :phone, nil, class: 'form-control', required: true %>
              </div>
              <% if ENV['RAZORPAY_KEY_ID'] %>
                <button id="razorpay-payment-button" class="btn btn-lg btn-success w-100">Proceed to Payment</button>
              <% else %>
                <p class="text-danger">Razorpay credentials are not set up properly. Please contact the administrator.</p>
              <% end %>
            <% end %>
            <!-- Coupons Section -->
            <div id="coupon-section" class="coupon-section d-none mt-4">
              <h4>Coupons</h4>
              <div id="generate-coupon-section">
                <button id="generate-coupon-btn" class="coupon-btn">Generate Coupon</button>
                <span id="generate-coupon-loader" class="loader" style="display: none;"></span>
              </div>
              <div id="apply-coupon-section" style="display: none;">
                <div id="user-coupons-div"></div>
                <button id="apply-coupon-btn" class="coupon-btn mt-2">Apply Selected Coupon</button>
                <button id="refresh-coupon-btn" class="coupon-btn mt-2">Refresh Coupon</button>
              </div>
              <div id="manual-coupon-input" class="mt-3">
                <input type="text" id="manual-coupon-code" class="coupon-input" placeholder="Enter coupon code">
                <button id="apply-manual-coupon-btn" class="coupon-btn">Apply Coupon</button>
                <div id="manual-coupon-loader" class="loader" style="display: none;"></div>
              </div>
               <div id="coupon-info" class="coupon-info">
                        <p>Applied Coupon: <span id="applied-coupon">None</span></p>
                        <p>Discount: <span id="coupon-discount">â‚¹0.00</span></p>
                  </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <% if ENV['RAZORPAY_KEY_ID'] %>
      <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    <% end %>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/2.10.2/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/slick-carousel@1.8.1/slick/slick.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script>
      // Camp details and pricing

      // Camp details and pricing
      var campDetails = <%= @camp.details.to_json.html_safe %>;
      var campPrice = <%= @camp.camp_price.to_json.html_safe%>
      campDetails.sharing_fields = <%= @camp.sharing_fields.to_json.html_safe %>;


      campDetails.per_person_field = <%= @camp.per_person_field.to_json.html_safe %>;
      campDetails.per_km_field = <%= @camp.per_km_field.to_json.html_safe %>;

       campDetails.sharing_fields_data = [];

      // Sharing options array and corresponding flags in campPrice
      const sharingOptions = [
          { name: 'double', enabled: campPrice.double_sharing_enabled },
          { name: 'triple', enabled: campPrice.triple_sharing_enabled },
          { name: 'quad', enabled: campPrice.quad_sharing_enabled },
          { name: 'six', enabled: campPrice.six_sharing_enabled }
      ];

      // Iterate over sharingOptions and push enabled options into sharing_fields_data
      sharingOptions.forEach(function(option) {
          if (option.enabled) {
          campDetails.sharing_fields_data.push(option.name);
          }
      });
      console.log("campDetails",campDetails)


      function showLoader() {
        document.getElementById('loader').style.display = 'flex';
      }

      function hideLoader() {
        document.getElementById('loader').style.display = 'none';
      }

      // Utility functions
      function showNotification(message, type = 'error') {
        const backgroundColor = '#1e1e1e';
        const textColor = '#e0e0e0';
        let iconColor;

        switch(type) {
          case 'success':
      iconColor = '#4CAF50'; // Green
      break;
          case 'error':
      iconColor = 'red'; // Red
      break;
          default:
      iconColor = '#FFA500'; // Default to orange
        }

        Swal.fire({
          icon: type,
          title: type.charAt(0).toUpperCase() + type.slice(1),
          text: message,
          toast: true,
          position: 'top-end',
          showConfirmButton: false,
          showCloseButton: true,
          timer: 3000,
          timerProgressBar: true,
          customClass: {
          popup: 'small-notification'
          },
          background: backgroundColor,
          color: textColor,
          iconColor: iconColor,
        });
      }

      let dayPrices = {};
      // Store per-person prices for each sharing option
      const perPersonPrices = {
        double: 0,
        triple: 0,
        quad: 0,
        six: 0,
        person: 0,
        km: 0
      };

      let appliedCouponDiscount = 0;


      function isPriceValid() {
           const displayPrice = $('#display-price');
          const price = parseFloat(displayPrice.text().replace('â‚¹', '').trim());
          return price > 0;
        }


     $(document).ready(function() {
        // Initialize Flatpickr for date range selection
         const dateRange = document.getElementById('date-range');
        const dateError = document.getElementById('date-error');

        flatpickr("#date-range", {
          mode: "<%= @camp_price.fixed? ? "single" : "range" %>",
          minDate: "today",
          dateFormat: "Y-m-d",
          onChange: function(selectedDates, dateStr, instance) {
            if (<%= @camp_price.fixed? %>) {
              if (selectedDates.length === 1) {
                const formattedDate = formatDate(selectedDates[0]);
                makeAjaxCall(formattedDate);
                showLoader();
                dateRange.value = formattedDate;
              } else {
                instance.clear();
                showNotification("Please select a single date.", 'error');
              }
            } else {
              if (selectedDates.length === 2) {
                const [checkIn, checkOut] = selectedDates;
                if (checkIn.getTime() === checkOut.getTime()) {
                  instance.clear();
                  showNotification("Check-in and check-out dates cannot be the same. Please select different dates.", 'error');
                } else {
                  const formattedCheckIn = formatDate(checkIn);
                  const formattedCheckOut = formatDate(checkOut);
                  makeAjaxCall(formattedCheckIn, formattedCheckOut);
                  showLoader();
                  dateRange.value = `${formattedCheckIn} to ${formattedCheckOut}`;
                }
              }
            }
          },
          locale: {
            rangeSeparator: " to ",
            firstDayOfWeek: 1
          }
        });

        // Add event listeners to quantity inputs
        if (campDetails.sharing_fields) {
          ['double', 'triple', 'quad', 'six'].forEach(sharingType => {
              document.getElementById(`${sharingType}-sharing`).addEventListener('input', updatePrices);
          });
        }

        const bookNowBtn = $('#book-now-btn');
        const paymentForm = $('#payment-form');
        const razorpayBtn = $('#razorpay-payment-button');
        const displayPrice = $('#display-price');



        function updateButtonState() {
          bookNowBtn.prop('disabled', !isPriceValid());
        }

        function formatDate(date) {
          const year = date.getFullYear();
          const month = ('0' + (date.getMonth() + 1)).slice(-2);
          const day = ('0' + date.getDate()).slice(-2);
          return `${year}-${month}-${day}`;
        }

        updateButtonState();

        displayPrice.on('DOMSubtreeModified', updateButtonState);

        bookNowBtn.on('click', function() {
          if (isPriceValid()) {
            paymentForm.show();
            bookNowBtn.hide();
          }
        });
      });

      function makeAjaxCall(checkIn, checkOut) {
        $.ajax({
          url: '/get_day_prices',
          method: 'GET',
          data: {
            camp_id: '<%= @camp.id %>',
            check_in: checkIn,
            check_out: checkOut
          },
          success: function(response) {
          console.log('Dates submitted successfully:', response);
          dayPrices = response.day_prices;

          updateSharingPrices(response);
          hideLoader();
          document.getElementById('check_in_date').value = checkIn;
          document.getElementById('check_out_date').value = checkOut;
          },
          error: function(error) {
            console.error('Error submitting dates:', error);
            hideLoader();
          }
        });
      }

     function updateSharingPrices(response) {
      const averagePrices = response.average_per_person_prices;
      const totalDays = response.total_days;
      const dayPrices = response.day_prices;

      const sharingOptions = ['double', 'triple', 'quad', 'six'];

      sharingOptions.forEach(sharing => {
        if (campDetails.sharing_fields && campDetails.sharing_fields_data.includes(sharing)) {
          const averagePrice = parseFloat(averagePrices[sharing]);
          perPersonPrices[sharing] = averagePrice;
          const quantity = parseInt(document.getElementById(`${sharing}-sharing`).value, 10) || 0;
          $(`#${sharing}-per-person`).text('(â‚¹' + averagePrice.toFixed(2) + ' per person)');
          $(`#${sharing}-per-person`).show();
          $(`#${sharing}-sharing-info`).removeClass('d-none');
        }
      });

      if (campDetails.per_person_field) {
        $('#person-count').removeClass('d-none');
      }

       if (campDetails.per_km_field) {
        perPersonPrices.km = parseFloat(averagePrices);
        $('#per-km-price').text('(â‚¹' + perPersonPrices.km.toFixed(2) + ' per km)');
        $('#rafting-options').removeClass('d-none');
        
        // Update price based on selected distance
        const selectedDistance = $('input[name="distance"]:checked').val();
        const totalKmPrice = perPersonPrices.km * selectedDistance;
        $('#total-km-price').text('Total: â‚¹' + totalKmPrice.toFixed(2));
      }

     

      if (campDetails.sharing_fields) $('#sharing-options').removeClass('d-none');
      $('#coupon-section, #calculate-price, #adventure-price-info').removeClass('d-none');

      updatePrices();
    }



      $('#date-range-clear').on('click', function() {
        flatpickr("#date-range").clear();
        $('#date-range').val('');
        $('#date-error').hide();
      });

      function changeQuantity(sharingType, change) {
        const input = document.getElementById(`${sharingType}-sharing`);
        let newValue = parseInt(input.value) + change;
        newValue = Math.max(newValue, 0);
        input.value = newValue;
        updatePrices();
      }

      function updateButtonState() {
        const bookNowBtn = $('#book-now-btn');
        bookNowBtn.prop('disabled', !isPriceValid());
      }

      function updatePrices() {
        let totalPrice = 0;
        let totalPersons = 0;

        if (campDetails.sharing_fields) {
          ['double', 'triple', 'quad', 'six'].forEach(sharingType => {
              if (campDetails.sharing_fields_data.includes(sharingType)) {
              const quantity = parseInt(document.getElementById(`${sharingType}-sharing`).value);
              const perPersonPrice = perPersonPrices[sharingType];
              const sharingMultiplier = sharingType === 'double' ? 2 :
                                          sharingType === 'triple' ? 3 :
                                          sharingType === 'quad' ? 4 : 6;
              const sharingPrice = quantity * perPersonPrice * sharingMultiplier;

              totalPrice += sharingPrice;
              totalPersons += quantity * sharingMultiplier;

              document.getElementById(`${sharingType}-price`).textContent = `â‚¹${sharingPrice.toFixed(2)}`;
              document.getElementById(`${sharingType}_sharing`).value = quantity;
              }
          });
        }

        if (campDetails.per_person_field && campDetails.per_km_field ) {
          const personCount = parseInt($('#number_of_persons').val());

          const selectedDistance = parseInt($('input[name="distance"]:checked').val());
          const perKmPrice = perPersonPrices.km;
          totalPrice += selectedDistance * perKmPrice * personCount;
           $('#selected_distance').val(selectedDistance)
        }else{

          if (campDetails.per_person_field) {
            const personCount = parseInt($('#number_of_persons').val());
            const perPersonPrice = perPersonPrices.person;
            totalPrice += personCount * perPersonPrice;
            totalPersons += personCount;
          }
  
          if (campDetails.per_km_field ) {
            const selectedDistance = parseInt($('input[name="distance"]:checked').val());
            const perKmPrice = perPersonPrices.km;
            totalPrice += selectedDistance * perKmPrice ;
            $('#selected_distance').val(selectedDistance)
          }

           if (campPrice.pricing_type == "fixed" ) {
            const campPr = campPrice.fixed_price;
            const personCount = parseInt($('#number_of_persons').val());
            totalPrice += campPr * personCount;
            totalPersons += personCount;
          }
        }

        const personInput = parseInt($('#number_of_persons').val());
        $('#display-price').text(`â‚¹${totalPrice.toFixed(2)}`);
        $('#total_price').val(totalPrice);
        $('#hidden_number_of_persons').val(personInput);
       

        updateButtonState();
      }

      // Coupon related functions
      function fetchUserCoupons() {
        showLoader();
        let totalPrice = document.getElementById('total_price').value;
        let campId = '<%= @camp.id %>';
        $.ajax({
          url: '/user_coupons',
          method: 'GET',
          data: {
      camp_id: campId,
      total_price: totalPrice
          },
          headers: {
      'X-CSRF-Token': $('meta[name="csrf-token"]').attr('content')
          },
          success: function(response) {
      console.log('Fetched user coupons:', response);
      if (response.coupons && response.coupons.length > 0) {
        $('#generate-coupon-section').hide();
        $('#apply-coupon-section').show();
        populateUserCoupons(response.coupons, totalPrice);
      } else {
        $('#generate-coupon-section').show();
        $('#apply-coupon-section').hide();
      }
      $('.coupon-section').show();
      checkCouponVisibility();
      hideLoader();
          },
          error: function(xhr, status, error) {
      console.error('Error fetching coupons:', error);
      showNotification('Error fetching coupons. Please try again.', 'error');
      hideLoader();
          }
        });
      }

      function populateUserCoupons(coupons, totalPrice) {
        let $couponDiv = $('#user-coupons-div');
        $couponDiv.empty();
        console.log('Populating coupons:', coupons);
        console.log('Total price:', totalPrice);

        coupons.forEach(function(coupon) {
          let isEligible = +totalPrice >= coupon.min_amount;
          let eligibilityHtml = isEligible
      ? '<span class="eligibility eligible"><i class="fas fa-check-circle"></i> Eligible</span>'
      : `<span class="eligibility not-eligible">Add â‚¹${(coupon.min_amount - totalPrice).toFixed(2)} more to apply</span>`;

          let couponHtml = `
      <div class="coupon-item ${isEligible ? 'eligible' : 'not-eligible'}" data-coupon-code="${coupon.code}">
        <input type="radio" name="coupon" value="${coupon.code}" id="coupon-${coupon.id}" ${isEligible ? '' : 'disabled'}>
        <label for="coupon-${coupon.id}">
          <div class="coupon-code">
            ${coupon.code}
            <button class="copy-btn" data-code="${coupon.code}" title="Copy Coupon Code">
              <i class="fas fa-copy"></i>
            </button>
          </div>
          <div class="coupon-details">
            â‚¹${coupon.discount} off (Min. â‚¹${coupon.min_amount})
            <br>You save: â‚¹${coupon.discount}
          </div>
          ${eligibilityHtml}
        </label>
      </div>
          `;
          $couponDiv.append(couponHtml);
        });

        $couponDiv.on('click', '.copy-btn', function(e) {
          e.preventDefault();
          let couponCode = $(this).data('code');
          navigator.clipboard.writeText(couponCode).then(function() {
      showNotification(`Coupon code ${couponCode} copied to clipboard!`, 'success');
          }).catch(function(error) {
      showNotification('Failed to copy coupon code:', 'error');
          });
        });

        $couponDiv.on('change', 'input[name="coupon"]', function() {
          $('.coupon-item').removeClass('active');
          $(this).closest('.coupon-item').addClass('active');
        });

        console.log('Coupon div content:', $couponDiv.html());
      }

      function checkCouponVisibility() {
        console.log('Coupon section visibility:', $('.coupon-section').is(':visible'));
        console.log('Generate coupon section visibility:', $('#generate-coupon-section').is(':visible'));
        console.log('Apply coupon section visibility:', $('#apply-coupon-section').is(':visible'));
        console.log('User coupons div content:', $('#user-coupons-div').html());
      }

      function showCouponModal(coupons) {
        let $couponList = $('#coupon-list');
        $couponList.empty();
        coupons.forEach(function(coupon) {
          let couponHtml = `
      <div class="coupon-item">
        <span class="coupon-code">${coupon.code}</span> - â‚¹${coupon.discount} off (Min. â‚¹${coupon.min_amount})
      </div>
          `;
          $couponList.append(couponHtml);
        });
        $('.coupon-modal').show();
      }

      function generateCoupon() {
        let campId = '<%= @camp.id %>';

        showLoader();

        $.ajax({
          url: '/generate_coupon',
          method: 'POST',
          data: { camp_id: campId },
          headers: {
      'X-CSRF-Token': $('meta[name="csrf-token"]').attr('content')
          },
          success: function(response) {
      hideLoader();
      if (response.coupons && response.coupons.length > 0) {
        showCouponModal(response.coupons);
      } else if (response.coupon) {
        showNotification('Coupon generated successfully!', 'success');
        fetchUserCoupons();
      } else {
        showNotification(response.message || 'Failed to generate coupon.', 'error');
      }
          },
          error: function(xhr) {
      hideLoader();
      if (xhr.status == 401 && xhr.responseJSON && xhr.responseJSON.message) {
        console.log(xhr.responseJSON.message);
        showNotification(xhr.responseJSON.message, 'error');
      } else {
        console.log('No Coupons are Available right now.');
        showNotification('No Coupons are Available right now.', 'error');
      }
          }
        });
      }

      function getSelectedCoupon() {
          const selectedCoupon = $('input[name="coupon"]:checked').val();
          return selectedCoupon;
        }



        function applyCoupon(isManual) {
            let couponCode;
            if (isManual) {
                couponCode = $('#manual-coupon-code').val().trim();
            } else {
                couponCode = $('input[name="coupon"]:checked').val();
            }
            let campId = '<%= @camp.id %>';
            let totalPrice = $('#total_price').val();
            console.log("Total price:", totalPrice);

            if (!couponCode) {
                showNotification('Please select or enter a coupon code.', 'error');
                return;
            }

            $.ajax({
                url: '/apply_coupon',
                method: 'POST',
                data: {
                    coupon_code: couponCode,
                    camp_id: campId,
                    total_price: totalPrice
                },
                headers: {
                    'X-CSRF-Token': $('meta[name="csrf-token"]').attr('content')
                },
                success: function(response) {
                    if (response.success) {
                        var discount = parseFloat(response.discount);
                        $('#applied-coupon').text(couponCode);
                        $('#coupon-discount').text('â‚¹' + discount.toFixed(2));
                        $('#applied_coupon_id').val(couponCode);
                        $('#coupon-info').show();
                        $('#manual-coupon-input').hide();
                        showNotification('Coupon applied successfully!', 'success');

                        $('#apply-coupon-section').hide();
                        $('#manual-coupon-code').val('');

                        showCelebration();
                        $('#coupon-info').append('<button id="remove-discount-btn" class="btn btn-sm btn-danger mt-2">Remove Discount</button>');
                        console.log()
                        setTimeout(function() {
                            $('#coupon-info').removeClass('joy-animation');
                            console.log("here")
                        }, 500);

                        // Update the total price display
                        $('#master_total_price').val(totalPrice);
                        let newTotalPrice = totalPrice - discount;
                        $('#display-price').text('â‚¹' + newTotalPrice.toFixed(2));
                        $('#total_price').val(newTotalPrice);
                    } else {
                        showNotification(response.message, 'error');
                    }
                },
                error: function() {
                    showNotification('Error applying coupon. Please try again.', 'error');
                }
            });
        }


        function showCelebration() {
          const overlay = document.getElementById('celebrationOverlay');
          overlay.style.opacity = '1';
          overlay.style.pointerEvents = 'auto';

          // Create and animate confetti
          for (let i = 0; i < 50; i++) {
              createConfetti();
          }

          setTimeout(() => {
              overlay.style.opacity = '0';
              overlay.style.pointerEvents = 'none';
          }, 3000);
        }

        function createConfetti() {
          const confetti = document.createElement('div');
          confetti.className = 'confetti';
          confetti.style.left = Math.random() * 100 + 'vw';
          confetti.style.animationDuration = Math.random() * 3 + 2 + 's';
          confetti.style.backgroundColor = getRandomColor();

          document.body.appendChild(confetti);

          confetti.style.animation = 'confetti-fall 3s ease-out forwards';

          setTimeout(() => {
              confetti.remove();
          }, 5000);
        }

        function removeConfetti() {
          document.querySelectorAll('.confetti').forEach(c => c.remove());
        }

        function getRandomColor() {
            const colors = ['#ff0000', '#00ff00', '#0000ff', '#ffff00', '#ff00ff', '#00ffff'];
            return colors[Math.floor(Math.random() * colors.length)];
        }


         function removeDiscount() {
            $('#applied-coupon').text('None');
            $('#coupon-discount').text('â‚¹0.00');
            $('#applied_coupon_id').val('');
            $('#coupon-info').hide();
            $('#apply-coupon-section').show();
            $('#manual-coupon-input').show();
            $('#remove-discount-btn').remove();

            // Reset the total price to the original value
            let originalPrice =  document.getElementById('master_total_price').value
            $('#display-price').text('â‚¹' + originalPrice);
            $('#total_price').val(originalPrice);

            // Uncheck all radio buttons and remove active class
            $('input[name="coupon"]').prop('checked', false);
            $('.coupon-item').removeClass('active');

            showNotification('Discount removed', 'info');
        }

      // Event listeners
        $(document).ready(function() {
          $('#generate-coupon-btn').click(generateCoupon);
          $('#apply-coupon-btn').click(function() { applyCoupon(false); });
          $('#apply-manual-coupon-btn').click(function() { applyCoupon(true); });
          $('#refresh-coupon-btn').click(fetchUserCoupons);
          $(document).on('click', '#remove-discount-btn', removeDiscount);


          $('#decrease-persons').click(function() {
            let count = parseInt($('#number_of_persons').val(), 10);
            if (count > 1) {
              $('#number_of_persons').val(count - 1);
              updatePrices();
            }
          });

          $('#increase-persons').click(function() {
            let count = parseInt($('#number_of_persons').val(), 10);
            $('#number_of_persons').val(count + 1);
            updatePrices();
          });

          $('#number_of_persons').change(function() {
            updatePrices();
          });

          // Distance selection
          $('input[name="distance"]').change(function() {
            updatePrices();
          });

  
        });




      //  RazorPay Script and form validations



      // Handle form submission
         $(document).ready(function() {
      // Set up CSRF token in AJAX requests
          $.ajaxSetup({
              headers: {
                  'X-CSRF-Token': $('meta[name="csrf-token"]').attr('content')
              }
          });

          $('#payment-form').on('submit', function(e) {
              e.preventDefault();
              if (!validateForm()){
                  return
              }

              // If price is verified, open Razorpay
              amount =  document.getElementById('total_price').value
               openRazorpay(amount);

          });
        });


      // Function to open Razorpay
      function openRazorpay(amount) {
          var options = {
              key: '<%= ENV['RAZORPAY_KEY_ID'] %>',
              amount: amount * 100, // Razorpay expects amount in paise
              name: 'Your Company Name',
              description: 'Booking Payment',
              handler: function(response) {
                  $('#razorpay_payment_id').val(response.razorpay_payment_id);
                  $('#payment-form').off('submit').submit();
              },
              prefill: {
                  name: $('#name').val(),
                  email: $('#email').val(),
                  contact: $('#phone').val()
              },
              theme: {
                  color: '#F37254'
              }
          };
          var rzp = new Razorpay(options);
          rzp.open();
      }



      // payment  form vaidation


      function validateForm() {
          var name = $('#name').val().trim();
          var email = $('#email').val().trim();
          var phone = $('#phone').val().trim();
          var isValid = true;

          if (name === '') {
              showNotification('Please enter your name');
              isValid = false;
          }

          if (email === '') {
              showNotification('Please enter your email');
              isValid = false;
          } else if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
              showNotification('Please enter a valid email address');
              isValid = false;
          }

          if (phone === '') {
              showNotification('Please enter your phone number');
              isValid = false;
          } else if (!/^\d{10}$/.test(phone)) {
              showNotification('Please enter a valid 10-digit phone number');
              isValid = false;
          }

          return isValid;
      }

        document.addEventListener('DOMContentLoaded', function() {
            var slider = tns({
                container: '.camp-image-slider',
                items: 1,
                slideBy: 'page',
                autoplay: true,
                autoplayTimeout: 5000,
                autoplayButtonOutput: false,
                controls: false,
                nav: true,
                responsive: {
                    0: {
                        items: 1
                    }
                }
            });

            document.querySelector('.slider-arrow-prev').addEventListener('click', function() {
                slider.goTo('prev');
            });

            document.querySelector('.slider-arrow-next').addEventListener('click', function() {
                slider.goTo('next');
            });
        });
    </script>
  </body>
</html>